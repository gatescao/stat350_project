---
title: "final_project"
author: "Gates Cao"
date: "3/6/2018"
output: html_document
---
```{r,message=F}
library(tidyverse)
library(reshape2)
library(MASS)
library(leaps)
library(glmnet)
```

```{r}
Boston <- Boston
```

Problem: predict median house values

###Exploratory data analysis
```{r}
Boston %>%
  select(-chas) %>%
  pairs()
```

```{r}
#correlation matrix
cormat <- cor(Boston)
cormat
melted_cormat <- melt(cormat)
ggplot(data = melted_cormat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile()
```


###Simple linear regression
```{r}
attach(Boston)
plot(crim, medv)
lm_fit <- lm(crim ~ medv, data = Boston)
summary(lm_fit)
plot(lm_fit)
```

```{r}
plot(lstat, medv)
lm_fit <- lm(medv ~ lstat, data = Boston)
summary(lm_fit)
```

###Stepwise selection
```{r}
#Forward
fit_fwd <- regsubsets(medv ~., data = Boston, nvmax = 13, method = "forward")
fwd_summary <- summary(fit_fwd)
which.min(fwd_summary$cp)
which.min(fwd_summary$bic)
which.max(fwd_summary$adjr2)
fit_fwd %>% coef(11)
```

```{r}
best_fit_fwd <- tibble(
  num_pred = 1:13,
  RSS = fwd_summary$rss,
  Adj_R2 = fwd_summary$adjr2,
  Cp = fwd_summary$cp,
  BIC = fwd_summary$bic
) %>%
  gather(key = "statistics", value = "value", -num_pred) 

best_fit_fwd %>%
    ggplot(aes(x = num_pred, y = value)) +
    geom_point() +
    geom_line() +
    geom_vline(aes(xintercept = 11), color = "red") +
    facet_wrap(~ statistics, ncol = 2, scales = "free") +
    ggtitle("Forward selection")
```

```{r}
#Backward
fit_bwd <- regsubsets(medv ~., data = Boston, nvmax = 13, method = "backward")
bwd_summary <- summary(fit_bwd)
which.min(bwd_summary$cp)
which.min(bwd_summary$bic)
which.max(bwd_summary$adjr2)
fit_bwd %>% coef(11)
```

```{r}
best_fit_bwd <- tibble(
  num_pred = 1:13,
  RSS = bwd_summary$rss,
  Adj_R2 = bwd_summary$adjr2,
  Cp = bwd_summary$cp,
  BIC = bwd_summary$bic
) %>%
  gather(key = "statistics", value = "value", -num_pred) 

best_fit_bwd %>%
    ggplot(aes(x = num_pred, y = value)) +
    geom_point() +
    geom_line() +
    geom_vline(aes(xintercept = 11), color = "red") +
    facet_wrap(~ statistics, ncol = 2, scales = "free") +
    ggtitle("Backward selection")
```

```{r}
#Best first-order linear model
lm_fit <- lm(medv ~ crim + zn + chas + nox + rm + dis + rad + tax + ptratio + black + lstat, data = Boston)
summary(lm_fit) #Rsquared = 0.7406
```

```{r}
#Diagnostic plots
par(mfrow = c(2,2))
plot(lm_fit)
par(mfrow = c(1,1))
```

```{r}
#Mean squared error
mean((Boston$medv - lm_fit$fitted.values)^2)
```

```{r}
comat <- Boston %>%
    dplyr::select(crim, zn, chas, nox, rm, dis, rad, tax, ptratio, black, lstat) %>%
    cor()

melted_cormat <- melt(cormat)
ggplot(data = melted_cormat, aes(x = Var1, y = Var2, fill = value)) + 
  geom_tile()
```

###Tests


###Shrinkage methods (lasso & ridge)
```{r}
x <- model.matrix(medv ~., Boston)[,-1]
y <- Boston$medv
```

###Ridge
```{r}
lambda_grid <- 10^seq(10, -2, length = 100)
ridge_mod <- glmnet(x, y, alpha = 0, lambda = lambda_grid)
dim(coef(ridge_mod))
```

```{r}
set.seed(1)
train <- sample(1:nrow(x), nrow(x)/2)
test <- (-train)
y_test <- y[test]
```

```{r}
ridge_mod <- glmnet(x[train,], y[train], alpha = 0, lambda = lambda_grid, thresh = 1e-12)
ridge_pred <- predict(ridge_mod, s = 4, newx = x[test,])
mean((ridge_pred - y_test)^2)
```

```{r}
lm(y ~ x, subset = train)
predict(ridge_mod, x = x[train,], y = y[train], s = 0, exact = T, type = "coefficients")[1:14,]
```

```{r}
set.seed(1)
cv.out <- cv.glmnet(x[train,], y[train], alpha = 0)
plot(cv.out)

bestlam <- cv.out$lambda.min
ridge_pred <- predict(ridge_mod, s = bestlam, newx = x[test,])
mean((ridge_pred - y_test)^2)
out <- glmnet(x, y, alpha = 0)
predict(out, type = "coefficients", s = bestlam)[1:14,]
```

###Lasso
```{r}
lasso_mod <- glmnet(x[train,], y[train], alpha = 1, lambda = lambda_grid)
plot(lasso_mod)
```

```{r}
set.seed(1)
cv.out <- cv.glmnet(x[train,], y[train], alpha = 1)
plot(cv.out)

bestlam <- cv.out$lambda.min
lasso_pred <- predict(lasso_mod, s = bestlam, newx = x[test,])
mean((lasso_pred - y_test)^2)
```

```{r}
out <- glmnet(x, y, alpha = 1, lambda = lambda_grid)
lasso_coef <- predict(out, type = "coefficients", s = bestlam)[1:14,]
lasso_coef
```